{% extends "base.html" %}
{% load static %}

{% block extra_head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
{% endblock %}
{% block content %}
<div class="min-h-screen flex items-start justify-center pt-12 px-4 sm:px-6 lg:px-8">
  <div class="max-w-2xl w-full bg-gip border-2 border-gold p-8 rounded-xl shadow-xl">
    <h2 class="text-center text-3xl font-extrabold text-gold mb-6">Add Property</h2>
    {% if messages %}
      <ul class="mb-4">
        {% for message in messages %}
          <li class="text-green-500">{{ message }}</li>
        {% endfor %}
      </ul>
    {% endif %}
    <form method="post" enctype="multipart/form-data" class="space-y-4">
      {% csrf_token %}
      {{ form.non_field_errors }}
      <div>
        <label for="id_name" class="block text-sm font-medium text-gold">Name</label>
        {{ form.name }}
        {% for error in form.name.errors %}
          <p class="text-red-500 text-sm">{{ error }}</p>
        {% endfor %}
      </div>
      <div>
        <label for="id_property_type" class="block text-sm font-medium text-gold">Type</label>
        {{ form.property_type }}
        {% for error in form.property_type.errors %}
          <p class="text-red-500 text-sm">{{ error }}</p>
        {% endfor %}
      </div>
      <div>
        <label for="id_location" class="block text-sm font-medium text-gold">Location</label>
        {{ form.location }}
        {% for error in form.location.errors %}
          <p class="text-red-500 text-sm">{{ error }}</p>
        {% endfor %}
      </div>
      <div>
        <label for="id_description" class="block text-sm font-medium text-gold">Description</label>
        {{ form.description }}
        {% for error in form.description.errors %}
          <p class="text-red-500 text-sm">{{ error }}</p>
        {% endfor %}
      </div>
      <div>
        <label for="id_address" class="block text-sm font-medium text-gold">Address</label>
        {{ form.address }}
        {% for error in form.address.errors %}
          <p class="text-red-500 text-sm">{{ error }}</p>
        {% endfor %}
      </div>
      <div id="map" class="w-full h-64 rounded-md border border-gold mb-4"></div>
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label for="id_guests" class="block text-sm font-medium text-gold">Guests</label>
          {{ form.guests }}
          {% for error in form.guests.errors %}
            <p class="text-red-500 text-sm">{{ error }}</p>
          {% endfor %}
        </div>
        <div>
          <label for="id_bedrooms" class="block text-sm font-medium text-gold">Bedrooms</label>
          {{ form.bedrooms }}
          {% for error in form.bedrooms.errors %}
            <p class="text-red-500 text-sm">{{ error }}</p>
          {% endfor %}
        </div>
        <div>
          <label for="id_bathrooms" class="block text-sm font-medium text-gold">Bathrooms</label>
          {{ form.bathrooms }}
          {% for error in form.bathrooms.errors %}
            <p class="text-red-500 text-sm">{{ error }}</p>
          {% endfor %}
        </div>
        <div>
          <label for="id_area" class="block text-sm font-medium text-gold">Area (mÂ²)</label>
          {{ form.area }}
          {% for error in form.area.errors %}
            <p class="text-red-500 text-sm">{{ error }}</p>
          {% endfor %}
        </div>
        <div>
          <label for="id_price_per_night" class="block text-sm font-medium text-gold">Price/Night</label>
          {{ form.price_per_night }}
          {% for error in form.price_per_night.errors %}
            <p class="text-red-500 text-sm">{{ error }}</p>
          {% endfor %}
        </div>
        <div>
          <label for="id_latitude" class="block text-sm font-medium text-gold">Latitude</label>
          {{ form.latitude }}
          {% for error in form.latitude.errors %}
            <p class="text-red-500 text-sm">{{ error }}</p>
          {% endfor %}
        </div>
        <div>
          <label for="id_longitude" class="block text-sm font-medium text-gold">Longitude</label>
          {{ form.longitude }}
          {% for error in form.longitude.errors %}
            <p class="text-red-500 text-sm">{{ error }}</p>
          {% endfor %}
        </div>
      </div>
      <div>
        <span class="block text-sm font-medium text-gold mb-1">Facilities</span>
        {{ form.facilities }}
        {% for error in form.facilities.errors %}
          <p class="text-red-500 text-sm">{{ error }}</p>
        {% endfor %}
      </div>
      {% if show_responsible %}
      <div>
        <label for="id_responsible" class="block text-sm font-medium text-gold">Responsible</label>
        {{ form.responsible }}
        {% for error in form.responsible.errors %}
          <p class="text-red-500 text-sm">{{ error }}</p>
        {% endfor %}
      </div>
      {% endif %}
      <div>
        <label for="id_photos" class="block text-sm font-medium text-gold">Photos</label>
        {{ form.photos }}
        {% for error in form.photos.errors %}
          <p class="text-red-500 text-sm">{{ error }}</p>
        {% endfor %}
      </div>
      <div>
        <button type="submit" class="w-full flex justify-center py-2 px-4 button-gold text-[#232323] rounded-md shadow-md hover:shadow-lg focus:outline-none">Save</button>
      </div>
    </form>
  </div>
</div>

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
  const map = L.map('map').setView([0, 0], 2);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);
  let marker;
  function setLocation(latlng) {
    if (marker) {
      marker.setLatLng(latlng);
    } else {
      marker = L.marker(latlng).addTo(map);
    }
    document.getElementById('id_latitude').value = latlng.lat.toFixed(6);
    document.getElementById('id_longitude').value = latlng.lng.toFixed(6);
    fetch(`https://nominatim.openstreetmap.org/reverse?lat=${latlng.lat}&lon=${latlng.lng}&format=json`)
      .then(r => r.json())
      .then(data => {
        if (data.display_name) {
          document.getElementById('id_address').value = data.display_name;
        }
        if (data.address) {
          document.getElementById('id_location').value =
            data.address.city || data.address.town || data.address.village || '';
        }
      })
      .catch(() => {});
  }
  map.on('click', e => setLocation(e.latlng));
  window.addEventListener('load', () => map.invalidateSize());
</script>
{% endblock %}
{% endblock %}
